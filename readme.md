
ä¸­æ–‡|English

# ğŸ† ä»é›¶å¼€å§‹è®¾è®¡ä¸€ä¸ªè½»é‡çº§åˆ†å¸ƒå¼ RPC æ¡†æ¶

---

## ğŸ“° å†™åœ¨å‰é¢

æœ¬é¡¹ç›®åŸºäº Spring + Netty + Nacos + kyro ä»é›¶å¼€å§‹è®¾è®¡å®ç°ä¸€æ¬¾è½»é‡çº§çš„åˆ†å¸ƒå¼ RPC æ¡†æ¶ï¼Œå†…å«è¯¦ç»†è®¾è®¡æ€è·¯ä»¥åŠå¼€å‘æ•™ç¨‹ï¼Œ**é€šè¿‡é€ è½®å­çš„æ–¹å¼æ¥å­¦ä¹ **ï¼Œè¿™æ ·èƒ½æ·±å…¥ç†è§£ RPC æ¡†æ¶çš„åº•å±‚åŸç†ã€‚ç›¸æ¯”ç®€å†ä¸Šä¸€å¾‹çš„ xxxx ç³»ç»Ÿï¼Œé€ è½®å­å¾ˆæ˜¾ç„¶æ›´èƒ½èµ¢å¾—é¢è¯•å®˜çš„é’ç ğŸ’–

å½“ç„¶ï¼Œå¤§å®¶åœ¨å®é™…é¡¹ç›®ä¸­å°‘é€ è½®å­ï¼Œå°½é‡å»ç”¨ç°æˆçš„ä¼˜ç§€æ¡†æ¶çœäº‹å¾ˆå¤š

æœ¬ç€å¼€æºç²¾ç¥ï¼Œæœ¬é¡¹ç›®READMEå·²ç»åŒæ­¥äº†è‹±æ–‡ç‰ˆæœ¬ã€‚å¦å¤–ï¼Œé¡¹ç›®çš„æºä»£ç çš„æ³¨é‡Šå¤§éƒ¨åˆ†ä¹Ÿä¿®æ”¹ä¸ºäº†è‹±æ–‡ã€‚

å¦‚è®¿é—®é€Ÿåº¦ä¸ä½³ï¼Œå¯æ”¾åœ¨ Gitee åœ°å€ï¼šhttps://gitee.com/Datalong/erpc-framework ã€‚å¦‚æœè¦æäº¤ issue æˆ–è€… pr çš„è¯ï¼Œè¯·åœ¨ Github æäº¤ï¼šhttps://github.com/Datalong/erpc-framework/issues ã€‚

ğŸ‘é¡¹ç›®æ¨èï¼š

1.[LeetCode_Offer](https://gitee.com/Datalong/leet-code--offer)(å›¾è§£é«˜é¢‘ç®—æ³•é¢˜ æ­£åœ¨æ›´æ–°ä¸­...)

2.[]

3.ã€ŒPassCSã€åŸºäºSpringCloudçš„è‡ªå­¦è€ƒè¯•ç³»ç»Ÿï¼Œå…¨é¢å¸®ä½ æ¢³ç†è®¡ç®—æœºç§‘å­¦çš„åŸºç¡€çŸ¥è¯†ã€‚


## å‰è¨€
è™½è¯´ RPC çš„åŸç†å®é™…ä¸éš¾ï¼Œä½†æ˜¯ï¼Œè‡ªå·±åœ¨å®ç°çš„è¿‡ç¨‹ä¸­è‡ªå·±ä¹Ÿé‡åˆ°äº†å¾ˆå¤šé—®é¢˜ã€‚erpc-framework ç›®å‰åªå®ç°äº† RPC æ¡†æ¶æœ€åŸºæœ¬çš„åŠŸèƒ½ï¼Œä¸€äº›å¯ä¼˜åŒ–ç‚¹éƒ½åœ¨ä¸‹é¢æåˆ°äº†ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è‡ªè¡Œå®Œå–„ã€‚

é€šè¿‡è¿™ä¸ªç®€æ˜“çš„è½®å­ï¼Œä½ å¯ä»¥å­¦åˆ° RPC çš„åº•å±‚åŸç†å’ŒåŸç†ä»¥åŠå„ç§ Java ç¼–ç å®è·µçš„è¿ç”¨ã€‚

ä½ ç”šè‡³å¯ä»¥æŠŠ erpc-framework å½“åšä½ çš„æ¯•è®¾/é¡¹ç›®ç»éªŒçš„é€‰æ‹©ï¼Œè¿™æ˜¯éå¸¸ä¸é”™ï¼å¯¹æ¯”å…¶ä»–æ±‚èŒè€…çš„é¡¹ç›®ç»éªŒéƒ½æ˜¯å„ç§ç³»ç»Ÿï¼Œé€ è½®å­è‚¯å®šæ˜¯æ›´åŠ èƒ½èµ¢å¾—é¢è¯•å®˜çš„é’çã€‚

å¦‚æœä½ è¦å°† erpc-framework å½“åšä½ çš„æ¯•è®¾/é¡¹ç›®ç»éªŒçš„è¯ï¼Œæˆ‘å¸Œæœ›ä½ ä¸€å®šè¦ææ‡‚ï¼Œè€Œä¸æ˜¯ç›´æ¥å¤åˆ¶ç²˜è´´æˆ‘çš„æ€æƒ³ã€‚ä½ å¯ä»¥ fork æˆ‘çš„é¡¹ç›®ï¼Œç„¶åè¿›è¡Œä¼˜åŒ–ã€‚å¦‚æœä½ è§‰å¾—çš„ä¼˜åŒ–æ˜¯æœ‰ä»·å€¼çš„è¯ï¼Œä½ å¯ä»¥æäº¤ PR ç»™æˆ‘ï¼Œæˆ‘ä¼šå°½å¿«å¤„ç†ã€‚

## æœ‰å“ªäº›ç‰¹æ€§
- å®ç°äº†åŸºäº Java åŸç”Ÿ Socket ä¼ è¾“ä¸ Netty ä¼ è¾“ä¸¤ç§ç½‘ç»œä¼ è¾“æ–¹å¼
- å®ç°äº†å››ç§åºåˆ—åŒ–ç®—æ³•ï¼ŒJson æ–¹å¼ã€Kryo ç®—æ³•ã€Hessian ç®—æ³•ä¸ Google Protobuf æ–¹å¼ï¼ˆé»˜è®¤é‡‡ç”¨ Kryoæ–¹å¼åºåˆ—åŒ–ï¼‰
- å®ç°äº†ä¸¤ç§è´Ÿè½½å‡è¡¡ç®—æ³•ï¼šéšæœºç®—æ³•ä¸è½®è½¬ç®—æ³•
- ä½¿ç”¨ Nacos ä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼Œç®¡ç†æœåŠ¡æä¾›è€…ä¿¡æ¯
- æ¶ˆè´¹ç«¯å¦‚é‡‡ç”¨ Netty æ–¹å¼ï¼Œä¼šå¤ç”¨ Channel é¿å…å¤šæ¬¡è¿æ¥
- å¦‚æ¶ˆè´¹ç«¯å’Œæä¾›è€…éƒ½é‡‡ç”¨ Netty æ–¹å¼ï¼Œä¼šé‡‡ç”¨ Netty çš„å¿ƒè·³æœºåˆ¶ï¼Œä¿è¯è¿æ¥
- æ¥å£æŠ½è±¡è‰¯å¥½ï¼Œæ¨¡å—è€¦åˆåº¦ä½ï¼Œç½‘ç»œä¼ è¾“ã€åºåˆ—åŒ–å™¨ã€è´Ÿè½½å‡è¡¡ç®—æ³•å¯é…ç½®
- å®ç°è‡ªå®šä¹‰çš„é€šä¿¡åè®®
- æœåŠ¡æä¾›ä¾§è‡ªåŠ¨æ³¨å†ŒæœåŠ¡
## é¡¹ç›®æ¨¡å—æ¦‚è§ˆ
```

roc-api â€”â€” é€šç”¨æ¥å£
rpc-common â€”â€” å®ä½“å¯¹è±¡ã€å·¥å…·ç±»ç­‰å…¬ç”¨ç±»
rpc-core â€”â€” æ¡†æ¶çš„æ ¸å¿ƒå®ç°
test-client â€”â€” æµ‹è¯•ç”¨æ¶ˆè´¹ä¾§
test-server â€”â€” æµ‹è¯•ç”¨æä¾›ä¾§

```
ä¼ è¾“åè®®ï¼ˆMRFåè®®ï¼‰
è°ƒç”¨å‚æ•°ä¸è¿”å›å€¼çš„ä¼ è¾“é‡‡ç”¨äº†å¦‚ä¸‹ ERF åè®®ï¼ˆ ERPC-Framework é¦–å­—æ¯ï¼‰ä»¥é˜²æ­¢ç²˜åŒ…ï¼š

```
+---------------+---------------+-----------------+-------------+
|  Magic Number |  Package Type | Serializer Type | Data Length |
|    4 bytes    |    4 bytes    |     4 bytes     |   4 bytes   |
+---------------+---------------+-----------------+-------------+
|                          Data Bytes                           |
|                   Length: ${Data Length}                      |
+---------------------------------------------------------------+
```

### å­—æ®µ	è§£é‡Š
Magic Number	é­”æ•°ï¼Œè¡¨è¯†ä¸€ä¸ª ERF åè®®åŒ…ï¼Œ0xCAFEBABE

Package Type	åŒ…ç±»å‹ï¼Œæ ‡æ˜è¿™æ˜¯ä¸€ä¸ªè°ƒç”¨è¯·æ±‚è¿˜æ˜¯è°ƒç”¨å“åº”

Serializer Type	åºåˆ—åŒ–å™¨ç±»å‹ï¼Œæ ‡æ˜è¿™ä¸ªåŒ…çš„æ•°æ®çš„åºåˆ—åŒ–æ–¹å¼

Data Length	æ•°æ®å­—èŠ‚çš„é•¿åº¦

Data Bytes	ä¼ è¾“çš„å¯¹è±¡ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªRpcRequestæˆ–RpcClientå¯¹è±¡ï¼Œå–å†³äºPackage Typeå­—æ®µï¼Œå¯¹è±¡çš„åºåˆ—åŒ–æ–¹å¼å–å†³äºSerializer Typeå­—æ®µã€‚




## ä»‹ç»

ERPCæ˜¯ä¸€æ¬¾åŸºäº Nacos+kyro+Netty å®ç°çš„ RPC æ¡†æ¶ã€‚ç½‘ç»œä¼ è¾“å®ç°äº†åŸºäº Java åŸç”Ÿ Socket ä¸ Netty ç‰ˆæœ¬ï¼Œå¹¶ä¸”å®ç°äº†å¤šç§åºåˆ—åŒ–ä¸è´Ÿè½½å‡è¡¡ç®—æ³•ã€‚ä»£ç æ³¨é‡Šè¯¦ç»†ï¼Œç»“æ„æ¸…æ™°ï¼Œå¹¶ä¸”é›†æˆäº† Check Style è§„èŒƒä»£ç ç»“æ„ï¼Œéå¸¸é€‚åˆé˜…è¯»å’Œå­¦ä¹ ã€‚

ç”±äº ä¿ºè‡ªèº«ç²¾åŠ›å’Œèƒ½åŠ›æœ‰é™ï¼Œå¦‚æœå¤§å®¶è§‰å¾—æœ‰éœ€è¦æ”¹è¿›å’Œå®Œå–„çš„åœ°æ–¹çš„è¯ï¼Œæ¬¢è¿ fork æœ¬é¡¹ç›®ï¼Œç„¶å clone åˆ°æœ¬åœ°ï¼Œåœ¨æœ¬åœ°ä¿®æ”¹åæäº¤ PR ç»™æˆ‘ï¼Œæˆ‘ä¼šåœ¨ç¬¬ä¸€æ—¶é—´ Review ä½ çš„ä»£ç ã€‚

æˆ‘ä»¬å…ˆä»ä¸€ä¸ªåŸºæœ¬çš„ RPC æ¡†æ¶è®¾è®¡æ€è·¯è¯´èµ·ï¼

### 1 ä¸€ä¸ªåŸºæœ¬çš„ RPC æ¡†æ¶è®¾è®¡æ€è·¯

>æ³¨æ„ ï¼šæˆ‘ä»¬è¿™é‡Œè¯´çš„ RPC æ¡†æ¶æŒ‡çš„æ˜¯ï¼šå¯ä»¥è®©å®¢æˆ·ç«¯ç›´æ¥è°ƒç”¨æœåŠ¡ç«¯æ–¹æ³•å°±åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·ç®€å•çš„æ¡†æ¶ï¼Œæ¯”å¦‚æˆ‘å‰é¢ä»‹ç»çš„ Dubboã€Motanã€gRPC è¿™äº›ã€‚ å¦‚æœéœ€è¦å’Œ HTTP åè®®æ‰“äº¤é“ï¼Œè§£æå’Œå°è£… HTTP è¯·æ±‚å’Œå“åº”ã€‚è¿™ç±»æ¡†æ¶å¹¶ä¸èƒ½ç®—æ˜¯â€œRPC æ¡†æ¶â€ï¼Œæ¯”å¦‚ Feignã€‚

ä¸€ä¸ªæœ€ç®€å•çš„ RPC æ¡†æ¶ä½¿ç”¨ç¤ºæ„å›¾å¦‚ä¸‹å›¾æ‰€ç¤º,è¿™ä¹Ÿæ˜¯ erpc-framework ç›®å‰çš„æ¶æ„ ï¼š

![](https://gitee.com/Datalong/picture/raw/master/2022-2-11/1644574339818-2.png)

æœåŠ¡æä¾›ç«¯ Server å‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡ï¼ŒæœåŠ¡æ¶ˆè´¹è€… Client é€šè¿‡æ³¨å†Œä¸­å¿ƒæ‹¿åˆ°æœåŠ¡ç›¸å…³ä¿¡æ¯ï¼Œç„¶åå†é€šè¿‡ç½‘ç»œè¯·æ±‚æœåŠ¡æä¾›ç«¯ Serverã€‚

ä½œä¸º RPC æ¡†æ¶é¢†åŸŸçš„ä½¼ä½¼è€…Dubboçš„æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤º,å’Œæˆ‘ä»¬ä¸Šé¢ç”»çš„å¤§ä½“ä¹Ÿæ˜¯å·®ä¸å¤šçš„ã€‚

![](https://gitee.com/Datalong/picture/raw/master/2022-2-11/1644574566797-3.png)

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ RPC æ¡†æ¶ä¸ä»…è¦æä¾›æœåŠ¡å‘ç°åŠŸèƒ½ï¼Œè¿˜è¦æä¾›è´Ÿè½½å‡è¡¡ã€å®¹é”™ç­‰åŠŸèƒ½ï¼Œè¿™æ ·çš„ RPC æ¡†æ¶æ‰ç®—çœŸæ­£åˆæ ¼çš„ã€‚

ç®€å•è¯´ä¸€ä¸‹è®¾è®¡ä¸€ä¸ªæœ€åŸºæœ¬çš„ RPC æ¡†æ¶çš„æ€è·¯ï¼š

![](https://gitee.com/Datalong/picture/raw/master/2022-2-11/1644574603800-rpc-architure-detail.png)

- 1.æ³¨å†Œä¸­å¿ƒ ï¼šæ³¨å†Œä¸­å¿ƒé¦–å…ˆæ˜¯è¦æœ‰çš„ï¼Œæ¨èä½¿ç”¨ Nacosã€‚æ³¨å†Œä¸­å¿ƒè´Ÿè´£æœåŠ¡åœ°å€çš„æ³¨å†Œä¸æŸ¥æ‰¾ï¼Œç›¸å½“äºç›®å½•æœåŠ¡ã€‚æœåŠ¡ç«¯å¯åŠ¨çš„æ—¶å€™å°†æœåŠ¡åç§°åŠå…¶å¯¹åº”çš„åœ°å€(ip+port)æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒï¼ŒæœåŠ¡æ¶ˆè´¹ç«¯æ ¹æ®æœåŠ¡åç§°æ‰¾åˆ°å¯¹åº”çš„æœåŠ¡åœ°å€ã€‚æœ‰äº†æœåŠ¡åœ°å€ä¹‹åï¼ŒæœåŠ¡æ¶ˆè´¹ç«¯å°±å¯ä»¥é€šè¿‡ç½‘ç»œè¯·æ±‚æœåŠ¡ç«¯äº†ã€‚

- 2.ç½‘ç»œä¼ è¾“ ï¼šæ—¢ç„¶è¦è°ƒç”¨è¿œç¨‹çš„æ–¹æ³•å°±è¦å‘è¯·æ±‚ï¼Œè¯·æ±‚ä¸­è‡³å°‘è¦åŒ…å«ä½ è°ƒç”¨çš„ç±»åã€æ–¹æ³•åä»¥åŠç›¸å…³å‚æ•°å§ï¼æ¨èåŸºäº NIO çš„ Netty æ¡†æ¶ã€‚æ¶ˆè´¹è€…è°ƒç”¨æä¾›è€…çš„æ–¹å¼å–å†³äºæ¶ˆè´¹è€…çš„å®¢æˆ·ç«¯é€‰æ‹©ï¼Œå¦‚é€‰ç”¨åŸç”Ÿ Socket åˆ™è¯¥æ­¥è°ƒç”¨ä½¿ç”¨ BIOï¼Œå¦‚é€‰ç”¨ Netty æ–¹å¼åˆ™è¯¥æ­¥è°ƒç”¨ä½¿ç”¨ NIOã€‚å¦‚è¯¥è°ƒç”¨æœ‰è¿”å›å€¼ï¼Œåˆ™æä¾›è€…å‘æ¶ˆè´¹è€…å‘é€è¿”å›å€¼çš„æ–¹å¼åŒç†ã€‚

- 3.åºåˆ—åŒ– ï¼šæ—¢ç„¶æ¶‰åŠåˆ°ç½‘ç»œä¼ è¾“å°±ä¸€å®šæ¶‰åŠåˆ°åºåˆ—åŒ–ï¼Œä½ ä¸å¯èƒ½ç›´æ¥ä½¿ç”¨ JDK è‡ªå¸¦çš„åºåˆ—åŒ–å§ï¼JDK è‡ªå¸¦çš„åºåˆ—åŒ–æ•ˆç‡ä½å¹¶ä¸”æœ‰å®‰å…¨æ¼æ´ã€‚ æ‰€ä»¥ï¼Œä½ è¿˜è¦è€ƒè™‘ä½¿ç”¨å“ªç§åºåˆ—åŒ–åè®®ï¼Œæ¯”è¾ƒå¸¸ç”¨çš„æœ‰ hession2ã€kyroã€protostuffã€‚

- 4.åŠ¨æ€ä»£ç† ï¼š å¦å¤–ï¼ŒåŠ¨æ€ä»£ç†ä¹Ÿæ˜¯éœ€è¦çš„ã€‚å› ä¸º RPC çš„ä¸»è¦ç›®çš„å°±æ˜¯è®©æˆ‘ä»¬è°ƒç”¨è¿œç¨‹æ–¹æ³•åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·ç®€å•ï¼Œä½¿ç”¨åŠ¨æ€ä»£ç†å¯ä»¥å±è”½è¿œç¨‹æ–¹æ³•è°ƒç”¨çš„ç»†èŠ‚æ¯”å¦‚ç½‘ç»œä¼ è¾“ã€‚ä¹Ÿå°±æ˜¯è¯´å½“ä½ è°ƒç”¨è¿œç¨‹æ–¹æ³•çš„æ—¶å€™ï¼Œå®é™…ä¼šé€šè¿‡ä»£ç†å¯¹è±¡æ¥ä¼ è¾“ç½‘ç»œè¯·æ±‚ï¼Œä¸ç„¶çš„è¯ï¼Œæ€ä¹ˆå¯èƒ½ç›´æ¥å°±è°ƒç”¨åˆ°è¿œç¨‹æ–¹æ³•å‘¢ï¼Ÿ

- 5.è´Ÿè½½å‡è¡¡ ï¼šè´Ÿè½½å‡è¡¡ä¹Ÿæ˜¯éœ€è¦çš„ã€‚ä¸ºå•¥ï¼Ÿä¸¾ä¸ªä¾‹å­æˆ‘ä»¬çš„ç³»ç»Ÿä¸­çš„æŸä¸ªæœåŠ¡çš„è®¿é—®é‡ç‰¹åˆ«å¤§ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªæœåŠ¡éƒ¨ç½²åœ¨äº†å¤šå°æœåŠ¡å™¨ä¸Šï¼Œå½“å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚çš„æ—¶å€™ï¼Œå¤šå°æœåŠ¡å™¨éƒ½å¯ä»¥å¤„ç†è¿™ä¸ªè¯·æ±‚ã€‚é‚£ä¹ˆï¼Œå¦‚ä½•æ­£ç¡®é€‰æ‹©å¤„ç†è¯¥è¯·æ±‚çš„æœåŠ¡å™¨å°±å¾ˆå…³é”®ã€‚å‡å¦‚ï¼Œä½ å°±è¦ä¸€å°æœåŠ¡å™¨æ¥å¤„ç†è¯¥æœåŠ¡çš„è¯·æ±‚ï¼Œé‚£è¯¥æœåŠ¡éƒ¨ç½²åœ¨å¤šå°æœåŠ¡å™¨çš„æ„ä¹‰å°±ä¸å¤å­˜åœ¨äº†ã€‚è´Ÿè½½å‡è¡¡å°±æ˜¯ä¸ºäº†é¿å…å•ä¸ªæœåŠ¡å™¨å“åº”åŒä¸€è¯·æ±‚ï¼Œå®¹æ˜“é€ æˆæœåŠ¡å™¨å®•æœºã€å´©æºƒç­‰é—®é¢˜ï¼Œæˆ‘ä»¬ä»è´Ÿè½½å‡è¡¡çš„è¿™å››ä¸ªå­—å°±èƒ½æ˜æ˜¾æ„Ÿå—åˆ°å®ƒçš„æ„ä¹‰ã€‚
......

### 2 é¡¹ç›®åŸºæœ¬æƒ…å†µå’Œå¯ä¼˜åŒ–ç‚¹
ä¸ºäº†å¾ªåºæ¸è¿›ï¼Œæœ€åˆçš„æ˜¯æ—¶å€™ï¼Œæˆ‘æ˜¯åŸºäºä¼ ç»Ÿçš„ BIO çš„æ–¹å¼ Socket è¿›è¡Œç½‘ç»œä¼ è¾“ï¼Œç„¶ååˆ©ç”¨ JDK è‡ªå¸¦çš„åºåˆ—åŒ–æœºåˆ¶ æ¥å®ç°è¿™ä¸ª RPC æ¡†æ¶çš„ã€‚åé¢ï¼Œæˆ‘å¯¹åŸå§‹ç‰ˆæœ¬è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå·²å®Œæˆçš„ä¼˜åŒ–ç‚¹å’Œå¯ä»¥å®Œæˆçš„ä¼˜åŒ–ç‚¹æˆ‘éƒ½åˆ—åœ¨äº†ä¸‹é¢ ğŸ‘‡ã€‚

ä¸ºä»€ä¹ˆè¦æŠŠå¯ä¼˜åŒ–ç‚¹åˆ—å‡ºæ¥ï¼Ÿ ä¸»è¦æ˜¯æƒ³ç»™å“ªäº›å¸Œæœ›ä¼˜åŒ–è¿™ä¸ª RPC æ¡†æ¶çš„å°ä¼™ä¼´ä¸€ç‚¹æ€è·¯ã€‚æ¬¢è¿å¤§å®¶ fork æœ¬ä»“åº“ï¼Œç„¶åè‡ªå·±è¿›è¡Œä¼˜åŒ–ã€‚

ä¸ºä»€ä¹ˆè¦æŠŠå¯ä¼˜åŒ–ç‚¹åˆ—å‡ºæ¥ï¼Ÿ ä¸»è¦æ˜¯æƒ³ç»™å“ªäº›å¸Œæœ›ä¼˜åŒ–è¿™ä¸ª RPC æ¡†æ¶çš„å°ä¼™ä¼´ä¸€ç‚¹æ€è·¯ã€‚æ¬¢è¿å¤§å®¶ fork æœ¬ä»“åº“ï¼Œç„¶åè‡ªå·±è¿›è¡Œä¼˜åŒ–ã€‚

ä½¿ç”¨ Nettyï¼ˆåŸºäº NIOï¼‰æ›¿ä»£ BIO å®ç°ç½‘ç»œä¼ è¾“ï¼›
 
ä½¿ç”¨å¼€æºçš„åºåˆ—åŒ–æœºåˆ¶ Kyroï¼ˆä¹Ÿå¯ä»¥ç”¨å…¶å®ƒçš„ï¼‰æ›¿ä»£ JDK è‡ªå¸¦çš„åºåˆ—åŒ–æœºåˆ¶ï¼›

ä½¿ç”¨ Nacos ç®¡ç†ç›¸å…³æœåŠ¡åœ°å€ä¿¡æ¯
 
Netty é‡ç”¨ Channel é¿å…é‡å¤è¿æ¥æœåŠ¡ç«¯

ä½¿ç”¨ `CompletableFuture` åŒ…è£…æ¥å—å®¢æˆ·ç«¯è¿”å›ç»“æœï¼ˆä¹‹å‰çš„å®ç°æ˜¯é€šè¿‡ `AttributeMap` ç»‘å®šåˆ° Channel ä¸Šå®ç°çš„ï¼‰ è¯¦è§ï¼šä½¿ç”¨ CompletableFuture ä¼˜åŒ–æ¥å—æœåŠ¡æä¾›ç«¯è¿”å›ç»“æœ

å¢åŠ  Netty å¿ƒè·³æœºåˆ¶ : ä¿è¯å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„è¿æ¥ä¸è¢«æ–­æ‰ï¼Œé¿å…é‡è¿ã€‚

å®¢æˆ·ç«¯è°ƒç”¨è¿œç¨‹æœåŠ¡çš„æ—¶å€™è¿›è¡Œè´Ÿè½½å‡è¡¡ ï¼šè°ƒç”¨æœåŠ¡çš„æ—¶å€™ï¼Œä»å¾ˆå¤šæœåŠ¡åœ°å€ä¸­æ ¹æ®ç›¸åº”çš„è´Ÿè½½å‡è¡¡ç®—æ³•é€‰å–ä¸€ä¸ªæœåŠ¡åœ°å€ã€‚psï¼šç›®å‰å®ç°äº†éšæœºè´Ÿè½½å‡è¡¡ç®—æ³•ä¸ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ã€‚

 å¤„ç†ä¸€ä¸ªæ¥å£æœ‰å¤šä¸ªç±»å®ç°çš„æƒ…å†µ ï¼šå¯¹æœåŠ¡åˆ†ç»„ï¼Œå‘å¸ƒæœåŠ¡çš„æ—¶å€™å¢åŠ ä¸€ä¸ª group å‚æ•°å³å¯ã€‚
 
 é›†æˆ Spring é€šè¿‡æ³¨è§£æ³¨å†ŒæœåŠ¡
 
 é›†æˆ Spring é€šè¿‡æ³¨è§£è¿›è¡ŒæœåŠ¡æ¶ˆè´¹ ã€‚
 
 å¢åŠ æœåŠ¡ç‰ˆæœ¬å· ï¼šå»ºè®®ä½¿ç”¨ä¸¤ä½æ•°å­—ç‰ˆæœ¬ï¼Œå¦‚ï¼š1.0ï¼Œé€šå¸¸åœ¨æ¥å£ä¸å…¼å®¹æ—¶ç‰ˆæœ¬å·æ‰éœ€è¦å‡çº§ã€‚ä¸ºä»€ä¹ˆè¦å¢åŠ æœåŠ¡ç‰ˆæœ¬å·ï¼Ÿä¸ºåç»­ä¸å…¼å®¹å‡çº§æä¾›å¯èƒ½ï¼Œæ¯”å¦‚æœåŠ¡æ¥å£å¢åŠ æ–¹æ³•ï¼Œæˆ–æœåŠ¡æ¨¡å‹å¢åŠ å­—æ®µï¼Œå¯å‘åå…¼å®¹ï¼Œåˆ é™¤æ–¹æ³•æˆ–åˆ é™¤å­—æ®µï¼Œå°†ä¸å…¼å®¹ï¼Œæšä¸¾ç±»å‹æ–°å¢å­—æ®µä¹Ÿä¸å…¼å®¹ï¼Œéœ€é€šè¿‡å˜æ›´ç‰ˆæœ¬å·å‡çº§ã€‚
 
 å¯¹ SPI æœºåˆ¶çš„è¿ç”¨
 
 å¢åŠ å¯é…ç½®æ¯”å¦‚åºåˆ—åŒ–æ–¹å¼ã€æ³¨å†Œä¸­å¿ƒçš„å®ç°æ–¹å¼,é¿å…ç¡¬ç¼–ç  ï¼šé€šè¿‡ API é…ç½®ï¼Œåç»­é›†æˆ Spring çš„è¯å»ºè®®ä½¿ç”¨é…ç½®æ–‡ä»¶çš„æ–¹å¼è¿›è¡Œé…ç½®
 
 å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é€šä¿¡åè®®ï¼ˆæ•°æ®åŒ…ç»“æ„ï¼‰é‡æ–°è®¾è®¡ ï¼Œå¯ä»¥å°†åŸæœ‰çš„ RpcRequestå’Œ RpcReuqest å¯¹è±¡ä½œä¸ºæ¶ˆæ¯ä½“ï¼Œç„¶åå¢åŠ å¦‚ä¸‹å­—æ®µï¼ˆå¯ä»¥å‚è€ƒï¼šã€ŠNetty å…¥é—¨å®æˆ˜å°å†Œã€‹å’Œ Dubbo æ¡†æ¶å¯¹è¿™å—çš„è®¾è®¡ï¼‰ï¼š
- é­”æ•° ï¼š é€šå¸¸æ˜¯ 4 ä¸ªå­—èŠ‚ã€‚è¿™ä¸ªé­”æ•°ä¸»è¦æ˜¯ä¸ºäº†ç­›é€‰æ¥åˆ°æœåŠ¡ç«¯çš„æ•°æ®åŒ…ï¼Œæœ‰äº†è¿™ä¸ªé­”æ•°ä¹‹åï¼ŒæœåŠ¡ç«¯é¦–å…ˆå–å‡ºå‰é¢å››ä¸ªå­—èŠ‚è¿›è¡Œæ¯”å¯¹ï¼Œèƒ½å¤Ÿåœ¨ç¬¬ä¸€æ—¶é—´è¯†åˆ«å‡ºè¿™ä¸ªæ•°æ®åŒ…å¹¶éæ˜¯éµå¾ªè‡ªå®šä¹‰åè®®çš„ï¼Œä¹Ÿå°±æ˜¯æ— æ•ˆæ•°æ®åŒ…ï¼Œä¸ºäº†å®‰å…¨è€ƒè™‘å¯ä»¥ç›´æ¥å…³é—­è¿æ¥ä»¥èŠ‚çœèµ„æºã€‚
- åºåˆ—åŒ–å™¨ç¼–å· ï¼šæ ‡è¯†åºåˆ—åŒ–çš„æ–¹å¼ï¼Œæ¯”å¦‚æ˜¯ä½¿ç”¨ Java è‡ªå¸¦çš„åºåˆ—åŒ–ï¼Œè¿˜æ˜¯ jsonï¼Œkyro ç­‰åºåˆ—åŒ–æ–¹å¼ã€‚
- æ¶ˆæ¯ä½“é•¿åº¦ ï¼š è¿è¡Œæ—¶è®¡ç®—å‡ºæ¥ã€‚
......

 ç¼–å†™æµ‹è¯•ä¸ºé‡æ„ä»£ç æä¾›ä¿¡å¿ƒ
 
 æœåŠ¡ç›‘æ§ä¸­å¿ƒï¼ˆç±»ä¼¼dubbo adminï¼‰
 
 è®¾ç½® gzip å‹ç¼©

## 3 è¿è¡Œé¡¹ç›®
### å¯¼å…¥é¡¹ç›®
fork é¡¹ç›®åˆ°è‡ªå·±çš„ä»“åº“ï¼Œç„¶åå…‹éš†é¡¹ç›®åˆ°è‡ªå·±çš„æœ¬åœ°ï¼š`git clone git@github.com:username/erpc-framework.git`ï¼Œä½¿ç”¨ IDEA æ‰“å¼€ï¼Œç­‰å¾…é¡¹ç›®åˆå§‹åŒ–å®Œæˆã€‚
### åˆå§‹åŒ– git hooks
è¿™ä¸€æ­¥ä¸»è¦æ˜¯ä¸ºäº†åœ¨ commit ä»£ç ä¹‹å‰ï¼Œè·‘ Check Styleï¼Œä¿è¯ä»£ç æ ¼å¼æ²¡é—®é¢˜ï¼Œå¦‚æœæœ‰é—®é¢˜çš„è¯å°±ä¸èƒ½æäº¤ã€‚

>ä»¥ä¸‹æ¼”ç¤ºçš„æ˜¯ Mac/Linux å¯¹åº”çš„æ“ä½œï¼ŒWindow ç”¨æˆ·éœ€è¦æ‰‹åŠ¨å°† `config/git-hooks` ç›®å½•ä¸‹çš„ `pre-commit` æ–‡ä»¶æ‹·è´åˆ° é¡¹ç›®ä¸‹çš„ `.git/hooks/` ç›®å½•ã€‚

æ‰§è¡Œä¸‹é¢è¿™äº›å‘½ä»¤ï¼š
```sh

âœ  erpc-framework git:(master) âœ— chmod +x ./init.sh
âœ  erpc-framework git:(master) âœ— ./init.sh

```
`init.sh` è¿™ä¸ªè„šæœ¬çš„ä¸»è¦ä½œç”¨æ˜¯å°† git commit é’©å­æ‹·è´åˆ°é¡¹ç›®ä¸‹çš„ `.git/hooks/` ç›®å½•ï¼Œè¿™æ ·ä½ æ¯æ¬¡ commit çš„æ—¶å€™å°±ä¼šæ‰§è¡Œäº†ã€‚
### CheckStyle æ’ä»¶ä¸‹è½½å’Œé…ç½®
`IntelliJ IDEA-> Preferences->Plugins->æœç´¢ä¸‹è½½ CheckStyle æ’ä»¶`ï¼Œç„¶åæŒ‰ç…§å¦‚ä¸‹æ–¹å¼è¿›è¡Œé…ç½®ã€‚

![](https://gitee.com/Datalong/picture/raw/master/2022-2-11/1644575555001-4.png)

é…ç½®å®Œæˆä¹‹åï¼ŒæŒ‰ç…§å¦‚ä¸‹æ–¹å¼ä½¿ç”¨è¿™ä¸ªæ’ä»¶ï¼

![](https://gitee.com/Datalong/picture/raw/master/2022-2-11/1644575597601-5.png)

### ä¸‹è½½è¿è¡Œ Nacos
è¿™é‡Œä½¿ç”¨ Docker æ¥ä¸‹è½½å®‰è£…ã€‚
#### æœç´¢nacosçš„é•œåƒ
```sh

# docker search nacos

```
#### æ¨èç¨³å®šç‰ˆç‰ˆæœ¬(å®˜æ–¹æ¨è1.3.1),å¦‚æœä¸æŒ‡å®šç‰ˆæœ¬çš„è¯åˆ™å°±æ˜¯latestç‰ˆæœ¬(å¯¹åº”nacosçš„1.4ç‰ˆæœ¬)
```sh

# docker pull nacos/nacos-server

```
#### æŸ¥çœ‹dockerä¸­æ‰€æœ‰ä¸‹è½½å¥½çš„é•œåƒåŒ…ï¼š
```sh

# docker images

```

![](https://gitee.com/Datalong/picture/raw/master/2022-2-11/1644576669508-Si.png)

#### å¯åŠ¨å‘½ä»¤ï¼š
```

docker run -d -e prefer_host_mode=127.0.0.1 -e MODE=standalone -v /nacos/logs:/opt/software/nacos/logs -p 8848:8848 --name nacos --restart=always nacos/nacos-server

```
- å‚æ•°è¯¦è§£ï¼š
```
-d åå°è¿è¡Œ
-e ç¯å¢ƒå˜é‡è®¾ç½®
-v æŸä¸ªå®¹å™¨çš„ç›®å½•:æ˜ å°„centosä¸Šçš„æŸä¸ªç›®å½•(æ ¹æ®å®é™…çš„è®¾ç½®)
-p å¤–éƒ¨è®¿é—®ç«¯å£:å†…éƒ¨è¢«æ˜ å°„ç«¯å£(æ ¹æ®å®é™…çš„è®¾ç½®)
-name å®¹å™¨çš„åç§°
-restart é‡å¯ç­–ç•¥
```
#### æŸ¥çœ‹nacoså¯åŠ¨æƒ…å†µåŠæ—¥å¿—ï¼š
æŸ¥çœ‹dockerå·²ç»å¯åŠ¨çš„å®¹å™¨ï¼š

`# docker ps` # å¦‚è¦æŸ¥çœ‹æ‰€æœ‰å®¹å™¨ï¼Œå¢åŠ å‚æ•° `-a`

![](https://gitee.com/Datalong/picture/raw/master/2022-2-11/1644576751371-6.png)


æŸ¥çœ‹dockeræŒ‡å®šå®¹å™¨çš„è¾“å‡ºæ—¥å¿—ï¼š
```sh

# docker logs --since 10m nacos # 10mæ˜¯æ—¶é—´å‚æ•°ï¼Œnacosæ˜¯å®¹å™¨åç§°ä¹Ÿå¯ä»¥æ˜¯id

```
å¼€æ”¾ nacos 8848ç«¯å£å¤–éƒ¨è¿æ¥ï¼š

é˜²ç«å¢™å¼€æ”¾`8848`ç«¯å£ï¼š

æŸ¥çœ‹é˜²ç«å¢™æŸä¸ªç«¯å£æ˜¯å¦å¼€æ”¾
`# firewall-cmd --query-port=8848/tcp`

![](https://gitee.com/Datalong/picture/raw/master/2022-2-11/1644576889050-7.png)

å¼€æ”¾é˜²ç«å¢™ç«¯å£8848ï¼Œé‡å¯é˜²ç«å¢™ç”Ÿæ•ˆ

```sh

# firewall-cmd --zone=public --add-port=8848/tcp --permanent

```
é‡å¯é˜²ç«å¢™
```sh

# systemctl restart firewalld

```
#### è®¿é—®nacosç®¡ç†ç•Œé¢ï¼š
http://xxx.xxx.xx.xxx:8848/nacos/#/login

ç”¨æˆ·å/å¯†ç ï¼šnacos/nacos

>åˆ°æ­¤ï¼Œnacosåœ¨ docker ä¸­çš„ä¸‹è½½å’Œå®‰è£…å·²ç»å®Œæ¯•ã€‚ä¸‹é¢ä»‹ç»ä¸‹å¦‚ä½•ä¿®æ”¹nacosé…ç½®

#### ä¿®æ”¹Nacosçš„é…ç½®ï¼š

docker ps # æ‰¾åˆ°nacoså®¹å™¨id

docker exec -it 1f392d60d21c /bin/bash # è¿›å…¥nacsoçš„å®¹å™¨ä¸­

exit # é€€å‡ºå®¹å™¨

![](https://gitee.com/Datalong/picture/raw/master/2022-2-11/1644577320705-8.png)


## 4 æ­£å¼ä½¿ç”¨
### æœåŠ¡æä¾›ç«¯
å®ç°æ¥å£ï¼š
```java

@Slf4j
@RpcService(group = "test1", version = "version1")
public class HelloServiceImpl implements HelloService {
    static {
        System.out.println("HelloServiceImplè¢«åˆ›å»º");
    }

    @Override
    public String hello(Hello hello) {
        log.info("HelloServiceImplæ”¶åˆ°: {}.", hello.getMessage());
        String result = "Hello description is " + hello.getDescription();
        log.info("HelloServiceImplè¿”å›: {}.", result);
        return result;
    }
}
	
@Slf4j
public class HelloServiceImpl2 implements HelloService {

    static {
        System.out.println("HelloServiceImpl2è¢«åˆ›å»º");
    }

    @Override
    public String hello(Hello hello) {
        log.info("HelloServiceImpl2æ”¶åˆ°: {}.", hello.getMessage());
        String result = "Hello description is " + hello.getDescription();
        log.info("HelloServiceImpl2è¿”å›: {}.", result);
        return result;
    }
}

```
å‘å¸ƒæœåŠ¡(ä½¿ç”¨ Netty è¿›è¡Œä¼ è¾“)ï¼š
```java

/**
 * Server: Automatic registration service via @RpcService annotation
 *
 * @author shuang.kou
 * @createTime 2020å¹´05æœˆ10æ—¥ 07:25:00
 */
@RpcScan(basePackage = {"github.javaguide.serviceimpl"})
public class NettyServerMain {
    public static void main(String[] args) {
        // Register service via annotation
        new AnnotationConfigApplicationContext(NettyServerMain.class);
        NettyServer nettyServer = new NettyServer();
        // Register service manually
        HelloService helloService2 = new HelloServiceImpl2();
        RpcServiceProperties rpcServiceConfig = RpcServiceProperties.builder()
                .group("test2").version("version2").build();
        nettyServer.registerService(helloService2, rpcServiceConfig);
        nettyServer.start();
    }
}

```
æœåŠ¡æ¶ˆè´¹ç«¯
```java

@Component
public class HelloController {

    @RpcReference(version = "version1", group = "test1")
    private HelloService helloService;

    public void test() throws InterruptedException {
        String hello = this.helloService.hello(new Hello("111", "222"));
        //å¦‚éœ€ä½¿ç”¨ assert æ–­è¨€ï¼Œéœ€è¦åœ¨ VM options æ·»åŠ å‚æ•°ï¼š-ea
        assert "Hello description is 222".equals(hello);
        Thread.sleep(12000);
        for (int i = 0; i < 10; i++) {
            System.out.println(helloService.hello(new Hello("111", "222")));
        }
    }
}

```
```java
ClientTransport rpcRequestTransport = new SocketRpcClient();
RpcServiceProperties rpcServiceConfig = RpcServiceProperties.builder()
        .group("test2").version("version2").build();
RpcClientProxy rpcClientProxy = new RpcClientProxy(rpcRequestTransport, rpcServiceConfig);
HelloService helloService = rpcClientProxy.getProxy(HelloService.class);
String hello = helloService.hello(new Hello("111", "222"));
System.out.println(hello);
```
### ç›¸å…³é—®é¢˜
##### ä¸ºä»€ä¹ˆè¦é€ è¿™ä¸ªè½®å­ï¼ŸDubbo ä¸é¦™ä¹ˆï¼Ÿ

å†™è¿™ä¸ª RPC æ¡†æ¶ä¸»è¦æ˜¯ä¸ºäº†é€šè¿‡é€ è½®å­çš„æ–¹å¼æ¥å­¦ä¹ ï¼Œæ£€éªŒè‡ªå·±å¯¹äºè‡ªå·±æ‰€æŒæ¡çš„çŸ¥è¯†çš„è¿ç”¨ã€‚

å®ç°ä¸€ä¸ªç®€å•çš„ RPC æ¡†æ¶å®é™…æ˜¯æ¯”è¾ƒå®¹æ˜“çš„ï¼Œä¸è¿‡ï¼Œç›¸æ¯”äºæ‰‹å†™ AOP å’Œ IoC è¿˜æ˜¯è¦éš¾ä¸€ç‚¹ç‚¹ï¼Œå‰ææ˜¯ä½ ææ‡‚äº† RPC çš„åŸºæœ¬åŸç†ã€‚

æˆ‘ä¹‹å‰ä»ç†è®ºå±‚é¢åœ¨åˆ†äº«è¿‡å¦‚ä½•å®ç°ä¸€ä¸ª RPCã€‚ä¸è¿‡ç†è®ºå±‚é¢çš„ä¸œè¥¿åªæ˜¯æ”¯æ’‘ï¼Œä½ çœ‹æ‡‚äº†ç†è®ºå¯èƒ½åªèƒ½ç³Šå¼„ä½é¢è¯•å®˜ã€‚å’±ç¨‹åºå‘˜è¿™ä¸€è¡Œè¿˜æ˜¯æœ€éœ€è¦åŠ¨æ‰‹èƒ½åŠ›ï¼Œå³ä½¿ä½ æ˜¯æ¶æ„å¸ˆçº§åˆ«çš„äººç‰©ã€‚å½“ä½ åŠ¨æ‰‹å»å®è·µæŸä¸ªä¸œè¥¿ï¼Œå°†ç†è®ºä»˜è¯¸å®è·µçš„æ—¶å€™ï¼Œä½ å°±ä¼šå‘ç°æœ‰å¾ˆå¤šå‘ç­‰ç€ä½ ã€‚

å¤§å®¶åœ¨å®é™…é¡¹ç›®ä¸Šè¿˜æ˜¯è¦å°½é‡å°‘é€ è½®å­ï¼Œæœ‰ä¼˜ç§€çš„æ¡†æ¶ä¹‹åå°½é‡å°±å»ç”¨ï¼ŒDubbo åœ¨å„ä¸ªæ–¹é¢åšçš„éƒ½æ¯”è¾ƒå¥½å’Œå®Œå–„ã€‚

å¦‚æœæˆ‘è¦è‡ªå·±å†™çš„è¯ï¼Œéœ€è¦æå‰äº†è§£å“ªäº›çŸ¥è¯†

Java ï¼š
- åŠ¨æ€ä»£ç†æœºåˆ¶ï¼›
- åºåˆ—åŒ–æœºåˆ¶ä»¥åŠå„ç§åºåˆ—åŒ–æ¡†æ¶çš„å¯¹æ¯”ï¼Œæ¯”å¦‚ hession2ã€kyroã€protostuffã€‚
- çº¿ç¨‹æ± çš„ä½¿ç”¨ï¼›
- CompletableFuture çš„ä½¿ç”¨
......

Netty ï¼š
- ä½¿ç”¨ Netty è¿›è¡Œç½‘ç»œä¼ è¾“ï¼›
- ByteBuf ä»‹ç»
- Netty ç²˜åŒ…æ‹†åŒ…
- Netty é•¿è¿æ¥å’Œå¿ƒè·³æœºåˆ¶

Nacos :
- åŸºæœ¬æ¦‚å¿µï¼›
- æ•°æ®ç»“æ„ï¼›
- å¦‚ä½•ä½¿ç”¨ Netflix å…¬å¸å¼€æºçš„ zookeeper å®¢æˆ·ç«¯æ¡†æ¶ Curator è¿›è¡Œå¢åˆ æ”¹æŸ¥ï¼›

